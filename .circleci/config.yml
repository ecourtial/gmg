version: '2.1'
executors:
  python:
    docker:
      - image: python:3.7
        name: python
      - image: mysql:8.0
        name: mysql
        environment:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: games
          MYSQL_USER: game
          MYSQL_PASSWORD: azerty
    working_directory: ~/repo
    resource_class: medium

commands:
  extra_checkout:
    description: Add extra packages and apps.
    steps:
      - checkout
      - run:
          name: "Install requirements for checkout"
          command: |
            apt update && apt install -y netcat default-mysql-client git openssh-client curl make nano libzip-dev
      - run:
          name: "Install required Python packages"
          command: |
            cd docker/python && pip3 install --no-cache-dir  -r requirements.txt && cd && cd repo
      - run:
          name: "Create appliation configuration"
          command: |
            cp configuration.json.dist configuration.json
      - run:
          name: "Starts the application"
          command: |
            nohup gunicorn --workers=1 --bind=0.0.0.0:9000 app:app &

jobs:
  unittest:
    executor: python
    steps:
      - extra_checkout
      - run:
      # Our primary container isn't MYSQL so run a sleep command until it's ready.
          name: Waiting for MySQL to be ready
          command: |
            for i in `seq 1 30`;
            do
              nc -z mysql 3306 && echo Success && exit 0
              echo -n .
              sleep 1
            done
            echo Failed waiting for MySQL && exit 1
      - run:
          name: Unit tests
          command: mysql -h mysql -u game -pazerty games < test/games_test.sql && make test_command_python

  linter:
    executor: python
    steps:
      - checkout  
      - run:
          name: Install pylint
          command: pip3 install pylint
      - run:
          name: Run pylint
          command: pylint --rcfile=standard.rc src/ ./app.py

workflows:
  version: '2.1'
  Code quality:
    jobs:
      - linter
      - unittest
